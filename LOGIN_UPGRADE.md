# 登录系统升级说明

## 概述
本次更新将小程序的用户登录系统从旧的 `wx.getUserInfo` 升级为新的 `wx.getUserProfile` API，以符合微信官方的最新要求。

## 主要变更

### 1. 登录页面 (client/pages/login/)

#### WXML 变更
- 移除了 button 组件的 `open-type="getUserInfo"` 和 `bindgetuserinfo` 属性
- 添加了兼容性处理，低版本仍可使用旧方式
- 清理了注释掉的旧代码

#### JavaScript 变更
- `getUserInfo` 方法完全重写
- 新增 `wx.getUserProfile` 支持
- 添加了版本兼容性检查
- 改进了错误处理和用户提示

### 2. 应用主文件 (client/app.js)

#### 新增功能
- 新增 `loginWithUserProfile` 方法处理新的登录流程
- 改进了 `loadUserData` 方法，添加本地存储检查
- 优化了 `addUser` 方法，添加本地存储和错误处理

#### 存储优化
- 登录成功后自动保存 token 和用户信息到本地存储
- 应用启动时优先检查本地存储的登录状态

## 技术细节

### wx.getUserProfile 特点
- 需要在用户点击事件中调用
- 每次调用都会弹出授权窗口
- 必须提供 `desc` 参数说明用途
- 从基础库 2.10.4 开始支持

### 兼容性处理
- 自动检测是否支持 `wx.getUserProfile`
- 低版本自动降级使用 `wx.getUserInfo`
- WXML 中使用 `wx.canIUse` 进行条件渲染

### 错误处理
- 用户拒绝授权时显示友好提示
- 网络请求失败时显示重试提示
- 登录成功时显示成功提示

## 使用说明

1. 用户首次使用或清除数据后需要重新授权
2. 每次调用 `wx.getUserProfile` 都会弹出授权窗口
3. 授权成功后用户信息会保存到本地，下次启动无需重新授权
4. 支持基础库 2.10.4 及以上版本的新特性，同时兼容低版本

## 注意事项

1. **隐私合规**: `wx.getUserProfile` 需要明确说明获取用户信息的用途
2. **用户体验**: 避免在页面加载时立即弹出授权窗口
3. **错误处理**: 妥善处理用户拒绝授权的情况
4. **数据安全**: 用户信息仅在必要时获取和使用

## 测试建议

1. 在不同版本的基础库中测试兼容性
2. 测试用户拒绝授权的场景
3. 测试网络异常情况下的错误处理
4. 验证本地存储的登录状态保持功能

---

更新时间: 2024年
更新内容: 升级用户登录系统至 wx.getUserProfile API